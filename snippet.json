{"generator":"Code Snippets v2.14.0","date_created":"2021-01-16 22:50","snippets":[{"name":"Timezone Fix for MemberPress Coupons","desc":"Forces MemberPress Coupons to use the correct Timezone as defined in Wordpress General Settings.\n\nCoupons with a Start date or Expiry date will run from 00:00:00 on the start date until 11:59:59 on the expiry date in the specified Timezone (instead of the MemberPress default timezone, UTC).","scope":"admin","code":"\/**\n * @snippet       Timezone Fix for MemberPress Coupons\n * @sourcecode    https:\/\/github.com\/spiderjay\/MemberPressCoupons-Timezone\n * @author        Jay Phillips\n * @compatible    Wordpress 5.6, MemberPress Plus 1.9.10\n *\/\n\n\/**\n * Display a notice when snippet is enabled\n *\/\n\nfunction fix_membpress_snippet_notice() {\n\tif ( get_post_type() == 'memberpresscoupon' ) {\n\t\t$tz = wp_timezone_string();\n?>\n<div class=\"notice notice-info is-dismissible\">\n\t<p><?php _e( 'The <strong>Timezone Fix for MemberPress Coupons Snippet<\/strong> is enabled. \n\t\t\tCoupons with a Start or Expiry date run from\/to midnight in the following timezone: <strong>'.$tz.'<\/strong>', 'alwk-membpress-snippet' ); ?><\/p>\n<\/div>\n<?php\n\t}\n}\t\nadd_action( 'admin_notices', 'fix_membpress_snippet_notice', 10 );\t\n\n\/**\n * Fix the timestamp when saving coupons\n *\/\n\nfunction fix_membpress_coupon_timezone($coupon){\n\t\n\t\/\/ get\/set the timezone setting from wordpress\n\t$tz = wp_timezone_string();\n\tdate_default_timezone_set($tz);\n\n\t\/\/ create datetime object \n\t$dt = new DateTime();\n\t\n\t\/\/ check for start date\n\tif ($coupon->rec->should_start) {\n\t\t\/\/ original start date in UTC\n\t\t$utc_start = $coupon->rec->starts_on;\n\t\t$dt->setTimestamp($utc_start);\n\t\t\n\t\t\/\/ create new start date using correct timezone \n\t\t$new_start = mktime(23, 59, 59, $dt->format('m'), $dt->format('d'), $dt->format('Y'));\n\t\t$coupon->rec->starts_on = $new_start;\n\t}\n\t\n\t\/\/ check for expiry date\n\tif ($coupon->rec->should_expire) {\n\t\t\/\/ original expiry in UTC\n\t\t$utc_ends = $coupon->rec->expires_on;\n\t\t$dt->setTimestamp($utc_ends);\n\t\t\n\t\t\/\/ create new expiry date using correct timezone\n\t\t$new_end = mktime(23, 59, 59, $dt->format('m'), $dt->format('d'), $dt->format('Y'));\n\t\t$coupon->rec->expires_on = $new_end;\n\t}\n\t\n\t\/\/ save changes\n\t$coupon->store_meta();\n}\nadd_action('mepr-coupon-save-meta', 'fix_membpress_coupon_timezone', 20, 1);\n\n\/**\n * Fix the date input fields when editing coupons\n *\/\n\nfunction fix_membpress_coupon_javascript() {\n\n\tif ( get_post_type() == 'memberpresscoupon' ) {\n\t\t\t\t\n\t\t$c = new MeprCoupon(get_the_ID());\n\n\t\t\/\/ check for a start date\n\t\t$start = $c->rec->starts_on;\n\n\t\t\/\/ check for an expiry\n\t\t$expiry = $c->rec->expires_on;\n\n\t\tif ($start || $expiry) {\n\n\t\t\t\/\/ get\/set the timezone setting from wordpress\n\t\t\t$tz = wp_timezone_string();\n\t\t\tdate_default_timezone_set($tz);\n\n\t\t\t\/\/ create datetime object \n\t\t\t$dt = new DateTime();\n\n\t\t\tif ($start) {\n\t\t\t\t$dt->setTimestamp($start);\n\t\t\t\t$dt->setTimezone(new DateTimeZone($tz));\n\t\t\t\t$st_dy = $dt->format('j');\n\t\t\t\t$st_mn = $dt->format('n');\n\t\t\t\t$st_yr = $dt->format('Y');\n\t\t\t} \n\n\t\t\tif ($expiry) {\n\t\t\t\t$dt->setTimestamp($expiry);\n\t\t\t\t$dt->setTimezone(new DateTimeZone($tz));\n\t\t\t\t$ex_dy = $dt->format('j');\n\t\t\t\t$ex_mn = $dt->format('n');\n\t\t\t\t$ex_yr = $dt->format('Y');\n\t\t\t}\n?>\n<script type=\"text\/javascript\">\n\tdocument.addEventListener(\"DOMContentLoaded\", function() {\n\t\t\/* MemberPress Coupon Post Admin *\/\n\t\tif (\/[?&]action=edit\/.test(location.search)) {\n\t\t\t\/* Editing existing coupon *\/\n\n\t\t\t<?php \tif ($start) { ?>\n\n\t\t\tdocument.getElementsByName('mepr_coupons_start_day')[0].value = <?php echo $st_dy; ?>;\n\t\t\tdocument.getElementsByName('mepr_coupons_start_month')[0].value = <?php echo $st_mn; ?>;\n\t\t\tdocument.getElementsByName('mepr_coupons_start_year')[0].value = <?php echo $st_yr; ?>;\n\n\t\t\t\t<?php \t} \n\n\t\t\tif ($expiry) { ?>\n\n\t\t\tdocument.getElementsByName('mepr_coupons_ex_day')[0].value = <?php echo $ex_dy; ?>;\n\t\t\tdocument.getElementsByName('mepr_coupons_ex_month')[0].value = <?php echo $ex_mn; ?>;\n\t\t\tdocument.getElementsByName('mepr_coupons_ex_year')[0].value = <?php echo $ex_yr; ?>;\n\t\t\tdocument.querySelector('#mepr_expire_coupon_box td strong').textContent = 'Midnight <?php echo $tz; ?>';\n\n\t\t\t<?php \t} ?>\n\n\t\t}\n\t});\n<\/script>\n<?php\n\t\t}\n\t\t\n\t}\n}\nadd_action( 'admin_footer', 'fix_membpress_coupon_javascript' );\n\n\n\/**\n * Fix the date in the columns on the Coupon list page\n *\/\n\nadd_action('manage_posts_custom_column', 'fix_membpress_columns_open', 9, 2);\nadd_action('manage_posts_custom_column', 'fix_membpress_columns_close', 11, 2);\n\t\t\t\nfunction fix_membpress_columns_open($column, $coupon_id) {\n    $mepr_options = MeprOptions::fetch();\n    $coupon = new MeprCoupon($coupon_id);\n\t$tz = wp_timezone_string();\n\n    if($coupon->ID !== null) {\n      switch($column) {\n        case 'coupon-starts':\n          if($coupon->post_status != 'trash') {\n            if($coupon->should_start) {\n\n\t\t\t\t\/\/ create datetime object \n\t\t\t\t$dt = new DateTime();\n\t\t\t\t$dt->setTimestamp($coupon->starts_on);\n\t\t\t\t$dt->setTimezone(new DateTimeZone($tz));\n\t\t\t\techo $dt->format('M d, Y');\n\t\t\t\techo '<span style=\"display:none;\">';\n            }\n          }\n          break;\n        case 'coupon-expires':\n          if($coupon->post_status != 'trash') {\n            if($coupon->should_expire) {\n\t\t\t\t\/\/ create datetime object \n\t\t\t\t$dt = new DateTime();\n\t\t\t\t$dt->setTimestamp($coupon->expires_on);\n\t\t\t\t$dt->setTimezone(new DateTimeZone($tz));\n\t\t\t\techo $dt->format('M d, Y');\n\t\t\t\techo '<span style=\"display:none;\">';\n            }\n          }\n          break;\n      }\n    }\n}\n\nfunction fix_membpress_columns_close($column, $coupon_id) {\n    $mepr_options = MeprOptions::fetch();\n    $coupon = new MeprCoupon($coupon_id);\n\n    if($coupon->ID !== null) {\n      switch($column) {\n        case 'coupon-starts':\n        case 'coupon-expires':\t\t\t  \n          if($coupon->post_status != 'trash') {\n            if($coupon->should_start) {\n\t\t\t\techo '<\/span>';\n            }\n          }\n          break;\n      }\n    }\n}","priority":"10"}]}
